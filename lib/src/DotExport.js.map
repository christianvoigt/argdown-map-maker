{"version":3,"sources":["../../src/DotExport.js"],"names":["_","DotExport","config","previousSettings","settings","useHtmlLabels","graphname","lineLength","groupColors","graphVizSettings","rankdir","concentrate","ratio","size","colorNodesByTag","defaultsDeep","name","request","response","dot","map","statements","arguments","groupCount","keys","Object","key","value","nodes","node","exportNodesRecursive","edges","edge","color","type","attributes","from","id","to","dotGroupId","groupLabel","labelTitle","foldAndEscape","escapeQuotesForDot","groupColor","length","level","labelloc","child","title","text","labelText","label","tags","tagsDictionary","tag","tagData","getLabel","isEmpty","titleLabel","textLabel","str","strArray","fold","i","escapeForHtml","join","s","replace","c","charCodeAt","n","useSpaces","a","push","line","substring","lastSpaceRgx","idx","search","nextIdx","module","exports"],"mappings":";;;;AAAA;;IAAYA,C;;;;;;IAENC,S;;;sBACOC,M,EAAO;AAChB,UAAIC,mBAAmB,KAAKC,QAA5B;AACA,UAAG,CAACD,gBAAJ,EAAqB;AACnBA,2BAAmB;AACjBE,yBAAgB,IADC;AAEjBC,qBAAW,cAFM;AAGjBC,sBAAY,EAHK;AAIjBC,uBAAa,CAAC,SAAD,EAAW,SAAX,EAAqB,SAArB,CAJI;AAKjBC,4BAAkB;AAChBC,qBAAS,IADO,EACD;AACfC,yBAAa,MAFG;AAGhBC,mBAAO,MAHS;AAIhBC,kBAAM;AAJU,WALD;AAWjBC,2BAAiB;AAXA,SAAnB;AAaD;AACD,WAAKV,QAAL,GAAgBJ,EAAEe,YAAF,CAAe,EAAf,EAAmBb,MAAnB,EAA2BC,gBAA3B,CAAhB;AACD;;;AACD,qBAAYD,MAAZ,EAAmB;AAAA;;AACjB,SAAKc,IAAL,GAAY,WAAZ;AACA,SAAKd,MAAL,GAAcA,MAAd;AACD;;;;wBACGe,O,EAASC,Q,EAAS;AACpB,UAAGD,QAAQE,GAAX,EAAe;AACb,aAAKjB,MAAL,GAAce,QAAQE,GAAtB;AACD,OAFD,MAEM,IAAGF,QAAQhB,SAAX,EAAqB;AACzB,aAAKC,MAAL,GAAce,QAAQhB,SAAtB;AACD;AACD,UAAG,CAACiB,SAASE,GAAV,IAAiB,CAACF,SAASG,UAA3B,IAAyC,CAACH,SAASI,SAAtD,EAAgE;AAC9D,eAAOJ,QAAP;AACD;;AAEDA,eAASK,UAAT,GAAsB,CAAtB;AACA,UAAIJ,MAAM,eAAa,KAAKf,QAAL,CAAcE,SAA3B,GAAqC,UAA/C;AACA,UAAG,KAAKF,QAAL,CAAcK,gBAAjB,EAAkC;AAChC,YAAMe,OAAOC,OAAOD,IAAP,CAAY,KAAKpB,QAAL,CAAcK,gBAA1B,CAAb;AADgC;AAAA;AAAA;;AAAA;AAEhC,+BAAee,IAAf,8HAAoB;AAAA,gBAAZE,GAAY;;AAClB,gBAAMC,QAAQ,KAAKvB,QAAL,CAAcK,gBAAd,CAA+BiB,GAA/B,CAAd;AACAP,mBAAOO,MAAI,OAAJ,GAAYC,KAAZ,GAAkB,OAAzB;AACD;AAL+B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAMjC;;AAlBmB;AAAA;AAAA;;AAAA;AAoBpB,8BAAgBT,SAASE,GAAT,CAAaQ,KAA7B,mIAAmC;AAAA,cAA3BC,IAA2B;;AACjCV,iBAAO,KAAKW,oBAAL,CAA0BD,IAA1B,EAAgCX,QAAhC,CAAP;AACD;AAtBmB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAwBpBC,aAAM,MAAN;;AAxBoB;AAAA;AAAA;;AAAA;AA0BpB,8BAAgBD,SAASE,GAAT,CAAaW,KAA7B,mIAAmC;AAAA,cAA3BC,IAA2B;;AACjC,cAAIC,QAAQ,OAAZ;AACA,cAAGD,KAAKE,IAAL,IAAa,QAAhB,EAAyB;AACvBD,oBAAQ,KAAR;AACD;AACD,cAAIE,aAAa,aAAWF,KAAX,GAAiB,aAAjB,GAA+BD,KAAKE,IAApC,GAAyC,IAA1D;AACAf,iBAAO,OAAKa,KAAKI,IAAL,CAAUC,EAAf,GAAoB,MAApB,GAA6BL,KAAKM,EAAL,CAAQD,EAArC,GAA0C,IAA1C,GAA+CF,UAA/C,GAA0D,MAAjE;AACD;AAjCmB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAmCpBhB,aAAO,KAAP;;AAEAD,eAASC,GAAT,GAAeA,GAAf;AACA,aAAOD,QAAP;AACD;;;yCACoBW,I,EAAMX,Q,EAAS;AAClC,UAAIC,MAAM,EAAV;AACA,UAAGU,KAAKK,IAAL,IAAa,OAAhB,EAAwB;AACtBhB,iBAASK,UAAT;AACA,YAAIgB,aAAa,aAAWrB,SAASK,UAArC;AACA,YAAIiB,aAAaX,KAAKY,UAAtB;AACA,YAAG,KAAKrC,QAAL,CAAcC,aAAjB,EAA+B;AAC7BmC,uBAAa,KAAKE,aAAL,CAAmBF,UAAnB,CAAb;AACAA,uBAAa,6CAA2CA,UAA3C,GAAsD,UAAnE;AACD,SAHD,MAGK;AACHA,uBAAa,OAAK,KAAKG,kBAAL,CAAwBH,UAAxB,CAAL,GAAyC,IAAtD;AACD;AACD,YAAII,aAAa,SAAjB;AACA,YAAG,KAAKxC,QAAL,CAAcI,WAAd,IAA6B,KAAKJ,QAAL,CAAcI,WAAd,CAA0BqC,MAA1B,GAAmC,CAAnE,EAAqE;AACnE,cAAG,KAAKzC,QAAL,CAAcI,WAAd,CAA0BqC,MAA1B,IAAoChB,KAAKiB,KAA5C,EAAkD;AAChDF,yBAAa,KAAKxC,QAAL,CAAcI,WAAd,CAA0BqB,KAAKiB,KAA/B,CAAb;AACD,WAFD,MAEK;AACHF,yBAAa,KAAKxC,QAAL,CAAcI,WAAd,CAA0B,KAAKJ,QAAL,CAAcI,WAAd,CAA0BqC,MAA1B,GAAmC,CAA7D,CAAb;AACD;AACF;;AAED1B,eAAO,gBAAcoB,UAAd,GAAyB,MAAhC;AACApB,eAAO,eAAaqB,UAAb,GAAwB,KAA/B;AACArB,eAAO,iBAAeyB,UAAf,GAA0B,OAAjC;AACAzB,eAAO,qBAAP;AACA,YAAI4B,WAAW,GAAf;AACA,YAAG,KAAK3C,QAAL,CAAcK,gBAAd,CAA+BC,OAA/B,IAA0C,IAA7C,EAAkD;AAChDqC,qBAAW,GAAX;AACD;AACD5B,eAAO,mBAAiB4B,QAAjB,GAA0B,SAAjC;;AA3BsB;AAAA;AAAA;;AAAA;AA6BtB,gCAAiBlB,KAAKD,KAAtB,mIAA4B;AAAA,gBAApBoB,KAAoB;;AAC1B7B,mBAAO,KAAKW,oBAAL,CAA0BkB,KAA1B,EAAiC9B,QAAjC,CAAP;AACD;AA/BqB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAgCtBC,eAAO,SAAP;AACA,eAAOA,GAAP;AACD;;AAED,UAAI8B,QAAQpB,KAAKY,UAAjB;AACA,UAAIS,OAAOrB,KAAKsB,SAAhB;AACA,UAAIC,QAAQ,EAAZ;AACA,UAAInB,QAAQ,SAAZ;AACA,UAAG,KAAK7B,QAAL,CAAcU,eAAd,IAAiCe,KAAKwB,IAAtC,IAA8CnC,SAASoC,cAA1D,EAAyE;AACvE,YAAMC,MAAM1B,KAAKwB,IAAL,CAAU,CAAV,CAAZ;AACA,YAAIG,UAAUtC,SAASoC,cAAT,CAAwBC,GAAxB,CAAd;AACA,YAAGC,WAAWA,QAAQvB,KAAtB,EAA4B;AAC1BA,kBAAQuB,QAAQvB,KAAhB;AACD;AACF;AACDmB,cAAQ,KAAKK,QAAL,CAAcR,KAAd,EAAqBC,IAArB,CAAR;AACA,UAAGrB,KAAKK,IAAL,IAAa,UAAhB,EAA2B;AACzBf,eAAO,OAAKU,KAAKQ,EAAV,GAAe,UAAf,GAA0Be,KAA1B,GAAgC,yDAAhC,GAA0FnB,KAA1F,GAAgG,cAAhG,GAA+GJ,KAAKK,IAApH,GAAyH,QAAhI;AACD,OAFD,MAEM,IAAGL,KAAKK,IAAL,IAAa,WAAhB,EAA4B;AAChCf,eAAO,OAAKU,KAAKQ,EAAV,GAAe,UAAf,GAA0Be,KAA1B,GAAgC,0DAAhC,GAA2FnB,KAA3F,GAAiG,4DAAjG,GAA8JJ,KAAKK,IAAnK,GAAwK,QAA/K;AACD;AACD,aAAOf,GAAP;AACD;;;6BACQ8B,K,EAAOC,I,EAAK;AACnB,UAAIE,QAAQ,EAAZ;AACA,UAAG,KAAKhD,QAAL,CAAcC,aAAjB,EAA+B;AAC7B+C,iBAAS,+EAAT;AACA,YAAG,CAACpD,EAAE0D,OAAF,CAAUT,KAAV,CAAJ,EAAqB;AACjB,cAAIU,aAAa,KAAKjB,aAAL,CAAmBO,KAAnB,CAAjB;AACAU,uBAAa,iCAA+BA,UAA/B,GAA0C,gBAAvD;AACAP,mBAASO,UAAT;AACH;AACD,YAAG,CAAC3D,EAAE0D,OAAF,CAAUR,IAAV,CAAJ,EAAoB;AAClB,cAAIU,YAAY,KAAKlB,aAAL,CAAmBQ,IAAnB,CAAhB;AACAU,sBAAY,8BAA4BA,SAA5B,GAAsC,YAAlD;AACAR,mBAASQ,SAAT;AACD;AACDR,iBAAS,kBAAT;AACD,OAbD,MAaK;AACHA,gBAAQ,OAAK,KAAKT,kBAAL,CAAwBM,KAAxB,CAAL,GAAoC,IAA5C;AACD;AACD,aAAOG,KAAP;AACD;;;kCACaS,G,EAAI;AAChB,UAAIC,WAAW,KAAKC,IAAL,CAAUF,GAAV,EAAe,KAAKzD,QAAL,CAAcG,UAA7B,EAAyC,IAAzC,CAAf;AACA,WAAI,IAAIyD,IAAI,CAAZ,EAAeA,IAAIF,SAASjB,MAA5B,EAAoCmB,GAApC,EAAwC;AACtCF,iBAASE,CAAT,IAAc,KAAKC,aAAL,CAAmBH,SAASE,CAAT,CAAnB,CAAd;AACD;AACD,aAAOF,SAASI,IAAT,CAAc,OAAd,CAAP;AACD;;;kCACaC,C,EAAG;AACb,aAAOA,EAAEC,OAAF,CAAU,gBAAV,EAA4B,UAASC,CAAT,EAAY;AAC3C,eAAO,OAAOA,EAAEC,UAAF,CAAa,CAAb,CAAP,GAAyB,GAAhC;AACH,OAFM,CAAP;AAGH;;;uCACkBT,G,EAAI;AACrB,aAAOA,IAAIO,OAAJ,CAAY,KAAZ,EAAkB,KAAlB,CAAP;AACD;;AAGD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;yBAEKD,C,EAAGI,C,EAAGC,S,EAAWC,C,EAAG;AACvB,UAAG,CAACN,CAAJ,EACE,OAAO,EAAP;;AAEAM,UAAIA,KAAK,EAAT;AACA,UAAIN,EAAEtB,MAAF,IAAY0B,CAAhB,EAAmB;AACfE,UAAEC,IAAF,CAAOP,CAAP;AACA,eAAOM,CAAP;AACH;AACD,UAAIE,OAAOR,EAAES,SAAF,CAAY,CAAZ,EAAeL,CAAf,CAAX;AACA,UAAI,CAAEC,SAAN,EAAiB;AAAE;AACfC,UAAEC,IAAF,CAAOC,IAAP;AACA,eAAO,KAAKZ,IAAL,CAAUI,EAAES,SAAF,CAAYL,CAAZ,CAAV,EAA0BA,CAA1B,EAA6BC,SAA7B,EAAwCC,CAAxC,CAAP;AACH,OAHD,MAIK;AAAE;AACH,YAAII,eAAe,YAAnB;AACA,YAAIC,MAAMH,KAAKI,MAAL,CAAYF,YAAZ,CAAV;AACA,YAAIG,UAAUT,CAAd;AACA,YAAIO,MAAM,CAAV,EAAa;AACTH,iBAAOA,KAAKC,SAAL,CAAe,CAAf,EAAkBE,GAAlB,CAAP;AACAE,oBAAUF,GAAV;AACH;AACDL,UAAEC,IAAF,CAAOC,IAAP;AACA,eAAO,KAAKZ,IAAL,CAAUI,EAAES,SAAF,CAAYI,OAAZ,CAAV,EAAgCT,CAAhC,EAAmCC,SAAnC,EAA8CC,CAA9C,CAAP;AACH;AACJ;;;;;;AAGHQ,OAAOC,OAAP,GAAiB;AACfjF,aAAWA;AADI,CAAjB","file":"DotExport.js","sourcesContent":["import * as _ from 'lodash';\n\nclass DotExport{\n  set config(config){\n    let previousSettings = this.settings;\n    if(!previousSettings){\n      previousSettings = {\n        useHtmlLabels : true,\n        graphname: 'Argument Map',\n        lineLength: 25,\n        groupColors: [\"#DADADA\",\"#BABABA\",\"#AAAAAA\"],\n        graphVizSettings: {\n          rankdir: 'BT', //BT | TB | LR | RL\n          concentrate: 'true',\n          ratio: 'auto',\n          size: '10,10'\n        },\n        colorNodesByTag: true\n      }\n    }\n    this.settings = _.defaultsDeep({}, config, previousSettings);\n  }\n  constructor(config){\n    this.name = \"DotExport\";\n    this.config = config;\n  }\n  run(request, response){\n    if(request.dot){\n      this.config = request.dot;\n    }else if(request.DotExport){\n      this.config = request.DotExport;\n    }\n    if(!response.map || !response.statements || !response.arguments){\n      return response;\n    }\n        \n    response.groupCount = 0;\n    let dot = \"digraph \\\"\"+this.settings.graphname+\"\\\" {\\n\\n\";\n    if(this.settings.graphVizSettings){\n      const keys = Object.keys(this.settings.graphVizSettings);\n      for(let key of keys){\n        const value = this.settings.graphVizSettings[key];\n        dot += key+\" = \\\"\"+value+\"\\\";\\n\";\n      }\n    }\n\n    for(let node of response.map.nodes){\n      dot += this.exportNodesRecursive(node, response);\n    }\n\n    dot +=\"\\n\\n\";\n\n    for(let edge of response.map.edges){\n      let color = \"green\";\n      if(edge.type == \"attack\"){\n        color = \"red\";\n      }\n      let attributes = \"color=\\\"\"+color+\"\\\", type=\\\"\"+edge.type+\"\\\"\";\n      dot += \"  \"+edge.from.id + \" -> \" + edge.to.id + \" [\"+attributes+\"];\\n\";\n    }\n\n    dot += \"\\n}\";\n\n    response.dot = dot;\n    return response;\n  }\n  exportNodesRecursive(node, response){\n    let dot = \"\";\n    if(node.type == \"group\"){\n      response.groupCount++;\n      let dotGroupId = \"cluster_\"+response.groupCount;\n      let groupLabel = node.labelTitle;\n      if(this.settings.useHtmlLabels){\n        groupLabel = this.foldAndEscape(groupLabel);\n        groupLabel = \"<<FONT FACE=\\\"Arial\\\" POINT-SIZE=\\\"10\\\">\"+groupLabel+\"</FONT>>\";\n      }else{\n        groupLabel = \"\\\"\"+this.escapeQuotesForDot(groupLabel)+\"\\\"\";\n      }\n      let groupColor = \"#CCCCCC\";\n      if(this.settings.groupColors && this.settings.groupColors.length > 0){\n        if(this.settings.groupColors.length >= node.level){\n          groupColor = this.settings.groupColors[node.level];\n        }else{\n          groupColor = this.settings.groupColors[this.settings.groupColors.length - 1];\n        }\n      }\n      \n      dot += \"\\nsubgraph \"+dotGroupId+\" {\\n\";\n      dot += \"  label = \"+groupLabel+\";\\n\";\n      dot += \"  color = \\\"\"+groupColor+\"\\\";\\n\";\n      dot += \"  style = filled;\\n\";\n      let labelloc = \"t\"\n      if(this.settings.graphVizSettings.rankdir == \"BT\"){\n        labelloc = \"b\";\n      }\n      dot += \" labelloc = \\\"\"+labelloc+\"\\\";\\n\\n\";\n      \n      for(let child of node.nodes){\n        dot += this.exportNodesRecursive(child, response);\n      }\n      dot += \"\\n}\\n\\n\";\n      return dot;\n    }\n    \n    let title = node.labelTitle;\n    let text = node.labelText;\n    let label = \"\";\n    let color = \"#63AEF2\";\n    if(this.settings.colorNodesByTag && node.tags && response.tagsDictionary){\n      const tag = node.tags[0];\n      let tagData = response.tagsDictionary[tag];\n      if(tagData && tagData.color){\n        color = tagData.color;\n      }        \n    }\n    label = this.getLabel(title, text);        \n    if(node.type == \"argument\"){\n      dot += \"  \"+node.id + \" [label=\"+label+\", shape=\\\"box\\\", style=\\\"filled,rounded\\\", fillcolor=\\\"\"+color+\"\\\",  type=\\\"\"+node.type+\"\\\"];\\n\";\n    }else if(node.type == \"statement\"){\n      dot += \"  \"+node.id + \" [label=\"+label+\", shape=\\\"box\\\", style=\\\"filled,rounded,bold\\\", color=\\\"\"+color+\"\\\", fillcolor=\\\"white\\\", labelfontcolor=\\\"white\\\", type=\\\"\"+node.type+\"\\\"];\\n\";\n    }        \n    return dot;\n  }\n  getLabel(title, text){\n    let label = \"\";\n    if(this.settings.useHtmlLabels){\n      label += \"<<FONT FACE=\\\"Arial\\\" POINT-SIZE=\\\"8\\\"><TABLE BORDER=\\\"0\\\" CELLSPACING=\\\"0\\\">\";\n      if(!_.isEmpty(title)){\n          let titleLabel = this.foldAndEscape(title);\n          titleLabel = \"<TR><TD ALIGN=\\\"center\\\"><B>\"+titleLabel+\"</B></TD></TR>\";\n          label += titleLabel;\n      }\n      if(!_.isEmpty(text)){\n        let textLabel = this.foldAndEscape(text);\n        textLabel = \"<TR><TD ALIGN=\\\"center\\\">\"+textLabel+\"</TD></TR>\";\n        label += textLabel;\n      }\n      label += \"</TABLE></FONT>>\";\n    }else{\n      label = \"\\\"\"+this.escapeQuotesForDot(title)+\"\\\"\";\n    }    \n    return label;\n  }\n  foldAndEscape(str){\n    let strArray = this.fold(str, this.settings.lineLength, true);\n    for(let i = 0; i < strArray.length; i++){\n      strArray[i] = this.escapeForHtml(strArray[i]);\n    }\n    return strArray.join('<br/>');\n  }\n  escapeForHtml(s) {\n      return s.replace(/[^0-9A-Za-z ]/g, function(c) {\n          return \"&#\" + c.charCodeAt(0) + \";\";\n      } );\n  }\n  escapeQuotesForDot(str){\n    return str.replace(/\\\"/g,'\\\\\"');\n  }\n\n\n  //http://jsfiddle.net/jahroy/Rwr7q/18/\n  //http://stackoverflow.com/questions/17895039/how-to-insert-line-break-after-every-80-characters\n  // Folds a string at a specified length, optionally attempting\n  // to insert newlines after whitespace characters.\n  //\n  // s          -  input string\n  // n          -  number of chars at which to separate lines\n  // useSpaces  -  if true, attempt to insert newlines at whitespace\n  // a          -  array used to build result\n  //\n  // Returns an array of strings that are no longer than n\n  // characters long.  If a is specified as an array, the lines\n  // found in s will be pushed onto the end of a.\n  //\n  // If s is huge and n is very small, this method will have\n  // problems... StackOverflow.\n  //\n\n  fold(s, n, useSpaces, a) {\n    if(!s)\n      return [];\n\n      a = a || [];\n      if (s.length <= n) {\n          a.push(s);\n          return a;\n      }\n      var line = s.substring(0, n);\n      if (! useSpaces) { // insert newlines anywhere\n          a.push(line);\n          return this.fold(s.substring(n), n, useSpaces, a);\n      }\n      else { // attempt to insert newlines after whitespace\n          var lastSpaceRgx = /\\s(?!.*\\s)/;\n          var idx = line.search(lastSpaceRgx);\n          var nextIdx = n;\n          if (idx > 0) {\n              line = line.substring(0, idx);\n              nextIdx = idx;\n          }\n          a.push(line);\n          return this.fold(s.substring(nextIdx), n, useSpaces, a);\n      }\n  }\n\n}\nmodule.exports = {\n  DotExport: DotExport\n}\n"]}